# Project Memory

## System Configuration
- **Project**: Simple Agent (Go)
- **Current Version**: v1.1.39
- **Build**: `go build main.go`

## Key Decisions & Lessons Learned
- **System Prompt & Diffing**: 
  - *Problem*: Agents often fail to apply unified diffs because they provide insufficient or mismatched context lines.
  - *Solution*: The system prompt (in `main.go`) now includes a specific "How to Include Context" section with 4 explicit steps (Identify, Copy, Prefix, Combine).
  - *Lesson*: Be extremely explicit about format requirements in the system prompt. Don't just say "include context", explain *how* to construct the block.

- **Memory Persistence**:
  - *Problem*: Agents often forget to check or update project memory (`remember.txt`).
  - *Solution*: Added a dedicated "**PROJECT MEMORY**" section to the system prompt in `main.go`.
  - *Lesson*: Instructions to "remember" must be proactive and unconditional in the system prompt, not just hidden in tool descriptions.

- **Large Output Handling**:
  - *Problem*: Tools (like `grep` or `cat`) sometimes produce massive output (>100k tokens), causing API errors (Status 400) and crashing the agent's context.
  - *Solution*: Modified `runSafeScript` in `main.go` to check output length. Outputs > 50,000 characters are now automatically saved to a file in `.simple_agent/outputs/`, and the agent receives a pointer to that file instead of the raw data.
  - *Lesson*: Always bound tool outputs. The LLM context window is finite; file-based offloading is a robust fallback for "firehose" data.

- **Build Safety**:
  - *Problem*: Pushed code with a compile error (unused variable) which broke the CI/CD pipeline for v1.1.34.
  - *Solution*: Created `setup_hooks.sh` to install a git pre-commit hook that runs `go build` automatically.
  - *Lesson*: **ALWAYS build locally before pushing.** Run `./setup_hooks.sh` in new environments to prevent regression.

## Git & Release Workflow
**CRITICAL**: ALWAYS autonomously commit code changes, push to git remote, AND tag them with the current version. Users rely on git tags to receive updates.

1.  **Commit**: Stage and commit all changes with a descriptive message.
1.  Bump `Version` constant in `main.go`.
2.  Update `CHANGELOG.md` with a new version header and notes.
3.  **Tag**: Create a git tag matching the current version (e.g., `git tag v1.1.25`).
4.  **Push**: Push changes and tags immediately: `git push origin main --tags`.

## Recent History
- **v1.1.23 (2025-12-07)**: Updated system prompt to improve `apply_udiff` reliability by enforcing context rules.
- **v1.1.24 (2025-12-07)**: Updated system prompt to explicitly enforce `remember.txt` usage and persistence.
- **v1.1.25 (2025-05-15)**: Added safety mechanism to save large tool outputs to disk instead of flooding context.
- **v1.1.26 (2025-05-15)**: Removed redundant 'git-wizard' skill (replaced by 'yolo-runner' + shell access).
- **v1.1.27 (2025-05-15)**: Added CI/CD pipeline (.github/workflows/release.yml) and install.sh script for automated binary distribution.
- **v1.1.28 (2025-05-15)**: Embedded `install.sh` into the binary. `autoUpdate` now uses this script to migrate users from `go install` to the binary release channel.
- **v1.1.29 (2025-05-15)**: Added cleanup logic to remove the legacy `go install` binary after successful migration.
- **v1.1.30 (2025-05-15)**: Added unconditional version printing on startup to improve UX and troubleshooting.
- **v1.1.31 (2025-05-15)**: Enhanced UX by adding Version and Model Name to the interactive Welcome message, ensuring visibility.
- **v1.1.32 (2025-05-15)**: Fixed self-update mechanism to support in-place updates. ADDED CRITICAL FALLBACK: If `install.sh` fails, `autoUpdate` now attempts `go install` to ensure legacy clients can still update.
- **v1.1.33 (2025-05-15)**: REMOVED "legacy cleanup" logic. It was deleting the binary after in-place updates via `go install`. Lesson: Do not assume `go install` is "legacy" or that users want to switch to the binary channel. Support both equally.
- **v1.1.34 (2025-05-15)**: Fixed GitHub Actions release workflow. Upgraded `softprops/action-gh-release` to v2 and used glob patterns to reliably find and upload binary assets.
- **v1.1.35 (2025-05-15)**: Fixed compile error (unused variable) in `autoUpdate` fallback logic. Added `setup_hooks.sh` to prevent future build breakages.
- **v1.1.36 (2025-05-15)**: Disabled Go cache in CI. Project has no external dependencies (`go.sum` doesn't exist), so `setup-go` cache warnings were noise.
- **v1.1.37 (2025-05-15)**: Fixed infinite update loop. Added `getLatestVersion` to check GitHub API before attempting update. Prevents 404s when already on latest.
- **v1.1.38 (2025-05-15)**: Fixed GitHub Actions race condition ("Too many retries"). Refactored workflow to separate parallel builds from atomic release creation using `upload-artifact`/`download-artifact`.
- **v1.1.39 (2025-05-15)**: Fixed auto-update regression. Replaced naive version equality check with semantic version comparison to prevent accidental downgrades.
- Switched vision skill model to 'gemini-2.5-flash' as requested.
- Added 'screenshot' capability to 'web-browser' skill using ScrapingBee API.
- Refactored 'vision' skill: 'analyze.py' now saves output to file by default and prints image metadata (size, dims) to stdout. Added Pillow dependency.
- Updated 'vision' skill: 'analyze.py' now generates a unique random filename for output if not specified.
- Released v1.1.40: Screenshot skill, Vision enhancements, and updated docs.
- Updated 'web-browser' skill: 'browse.py' now enables JavaScript rendering by default. Added '--no-js' flag to disable it.
- Released v1.1.41: Web Browser now defaults to JS rendering.
- Updated 'web-browser' skill: 'screenshot.py' now captures full page by default. Added '--no-full-page' flag to capture window only.
- Released v1.1.42: Web Browser screenshots now default to full-page.
- Updated 'vision' skill: Added '--image-model' argument to 'analyze.py' for custom model selection.
- Released v1.1.43: Vision skill now supports custom '--image-model'.
- Verified Skill Discovery Architecture: Agent automatically loads local skills from './skills' and baked-in skills from '~/.simple_agent/core_skills'. Local skills override core skills.
- Updated 'vision' skill: Default model is now 'gemini-3-pro-preview'.
- Released v1.1.44: Vision default model is now Gemini 3 Pro Preview.
- Updated 'web-browser' skill: 'browse.py' now includes links in the output formatted as '[text](url)'.
- Released v1.1.45: Web Browser now extracts links.
- Updated 'web-browser' skill: Switched search backend from Brave to SerpApi. Supports 'SERPAPI_API_KEY' or 'SERPAPI_KEY'.
- Released v1.1.46: Web Browser now uses SerpApi for search.
- Released v1.1.47: System prompt now includes the current date.
